// Blood Bank Admin Portal - Prisma Schema (SQLite Development Version)
// For quick setup and testing without PostgreSQL server

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// Enums (SQLite doesn't support enums, so we use strings with validation)
// These will be validated in the application layer

// User Model
model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Personal Information
  firstName String
  lastName  String
  email     String  @unique
  phone     String

  // Authentication
  password String?

  // User Type and Role (stored as strings, validated in app)
  userType String  @default("donor") // admin, donor, patient
  role     String  @default("user") // super_admin, admin, staff, user
  isActive Boolean @default(true)

  // Personal Details
  dateOfBirth DateTime?
  age         Int?
  gender      String? // male, female, other
  bloodGroup  String? // A+, A-, B+, B-, AB+, AB-, O+, O-

  // Address Information
  street   String?
  city     String?
  state    String?
  pincode  String?
  country  String? @default("India")

  // Medical History (stored as JSON strings in SQLite)
  hasChronicDiseases    Boolean @default(false)
  chronicDiseases       String? // JSON array as string
  medications           String? // JSON object as string
  allergies             String? // JSON array as string
  lastDonationDate      DateTime?
  isEligibleToDonate    Boolean @default(true)

  // Emergency Contact
  emergencyContactName         String?
  emergencyContactRelationship String?
  emergencyContactPhone        String?

  // Statistics
  totalDonations Int @default(0)
  totalRequests  Int @default(0)

  // Verification and Status
  isVerified       Boolean   @default(false)
  verificationDate DateTime?
  lastLogin        DateTime?
  loginAttempts    Int       @default(0)
  lockUntil        DateTime?

  // Preferences
  emailNotifications   Boolean @default(true)
  smsNotifications     Boolean @default(true)
  donationReminders    Boolean @default(true)

  // Relations
  donations Donation[] @relation("DonorDonations")
  documents Document[]
  notes     Note[]

  @@map("users")
}

// Document Model
model Document {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  type       String // id_proof, medical_report, blood_test, other
  filename   String
  url        String
  uploadDate DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("documents")
}

// Donation Model
model Donation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Donor Information
  donorId String
  donor   User   @relation("DonorDonations", fields: [donorId], references: [id])

  // Donor Details (cached for performance)
  donorName       String
  donorBloodGroup String // A+, A-, B+, B-, AB+, AB-, O+, O-
  donorAge        Int
  donorPhone      String
  donorEmail      String

  // Donation Details
  donationDate   DateTime @default(now())
  donationType   String   @default("whole_blood") // whole_blood, plasma, platelets, red_cells, double_red_cells
  donationCenter String   @default("Blood Alert")
  donationStatus String   @default("scheduled") // scheduled, in_progress, completed, cancelled, deferred

  // Pre-screening (stored as JSON string)
  preScreening String? // JSON string

  // Blood Collection Details
  volumeCollected       Int? // in ml
  bagNumber             String? @unique
  collectionStartTime   DateTime?
  collectionEndTime     DateTime?
  collectionDuration    Int? // in minutes
  complications         String? // JSON array as string

  // Blood Testing
  bloodGroupVerified String? // A+, A-, B+, B-, AB+, AB-, O+, O-
  hivResult          String? // positive, negative, pending
  hepatitisBResult   String? // positive, negative, pending
  hepatitisCResult   String? // positive, negative, pending
  syphilisResult     String? // positive, negative, pending
  malariaResult      String? // positive, negative, pending
  testingCompleted   Boolean @default(false)
  testingDate        DateTime?
  overallTestResult  String  @default("pending") // positive, negative, pending

  // Staff Information (stored as JSON string)
  medicalStaff String? // JSON string

  // Relations
  components Component[]
  notes      Note[]

  @@map("donations")
}

// Component Model (Blood Components)
model Component {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  componentType String // whole_blood, red_blood_cells, plasma, platelets, cryoprecipitate
  volume        Float
  unitNumber    String @unique
  
  // Storage Conditions (stored as JSON string)
  storageConditions String? // JSON string
  
  expiryDate DateTime?
  status     String   @default("available") // available, reserved, used, expired, discarded

  // Relations
  donationId String
  donation   Donation @relation(fields: [donationId], references: [id], onDelete: Cascade)

  @@map("components")
}

// Note Model (for administrative notes)
model Note {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  note     String
  addedBy  String
  addedAt  DateTime @default(now())

  // Relations (can be attached to User or Donation)
  userId     String?
  user       User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  donationId String?
  donation   Donation? @relation(fields: [donationId], references: [id], onDelete: Cascade)

  @@map("notes")
}
